<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í¥ë¶€ì í†µí•© API ëŒ€ì‹œë³´ë“œ (ë°°í¬ ì„œë²„)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Malgun Gothic',sans-serif; background:linear-gradient(135deg,#eef1f6 0%,#f8f9fb 100%); color:#333; padding:30px; }
        .container { max-width:1200px; margin:0 auto; }
        .header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:25px; border-radius:12px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.1); margin-bottom:30px; }
        .header h1 { font-size:30px; font-weight:bold; margin-bottom:5px; }
        .auth-switch { display:flex; justify-content:center; gap:15px; margin-bottom:25px; }
        .auth-switch button { padding:12px 28px; border:none; border-radius:8px; font-weight:bold; font-size:15px; cursor:pointer; transition:all 0.3s; background:white; color:#667eea; box-shadow:0 3px 8px rgba(0,0,0,0.05); }
        .auth-switch button.active { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; box-shadow:0 4px 12px rgba(102,126,234,0.4); transform:translateY(-1px); }
        .section { background:white; border-radius:12px; padding:25px; margin-bottom:25px; box-shadow:0 3px 10px rgba(0,0,0,0.05); transition:all 0.2s; }
        .section.hidden { display:none; }
        .section-title { font-size:20px; font-weight:bold; color:#444; margin-bottom:20px; border-bottom:2px solid #667eea; padding-bottom:10px; }
        input, select, textarea { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
        textarea { resize:vertical; min-height:80px; }
        .btn { padding:10px 20px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.2s; }
        .btn-primary { background:#667eea; color:white; }
        .btn-primary:hover { background:#5568d3; }
        .btn-success { background:#2ecc71; color:white; }
        .btn-success:hover { background:#27ae60; }
        .response-box { margin-top:15px; padding:15px; border-radius:6px; display:none; font-family:'Courier New',monospace; font-size:13px; }
        .response-box.show { display:block; }
        .response-box.success { background:#d4edda; border-left:4px solid #28a745; }
        .response-box.error { background:#f8d7da; border-left:4px solid #dc3545; }

        /* ì‹ ê³  ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .emergency-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:15px; margin-top:10px; }
        .emergency-card { background:#fff; border-radius:10px; padding:15px; box-shadow:0 3px 8px rgba(0,0,0,0.08); transition:transform 0.2s ease, box-shadow 0.2s ease; }
        .emergency-card:hover { transform:translateY(-3px); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
        .emergency-card .card-header { display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; }
        .emergency-card .report-id { color:#667eea; }
        .emergency-card .status { padding:3px 8px; border-radius:5px; font-size:12px; color:white; }
        .emergency-card.pending .status { background:#f39c12; }
        .emergency-card.confirmed .status { background:#e74c3c; }
        .emergency-card.resolved .status { background:#2ecc71; }
        .emergency-card.false_alarm .status { background:#95a5a6; }
        .emergency-card .ok { color:#2ecc71; font-weight:bold; }
        .emergency-card .no { color:#e74c3c; font-weight:bold; }
        .emergency-card .resolve-btn { width:100%; margin-top:10px; padding:8px; border:none; border-radius:6px; background:#2ecc71; color:white; font-weight:bold; cursor:pointer; }
        .emergency-card .resolved-label { margin-top:10px; background:#2ecc71; color:white; text-align:center; border-radius:6px; padding:8px 0; font-weight:bold; }

        /* ì–´ë¥´ì‹  ì¹´ë“œ */
        .users-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; margin-top:20px; }
        .user-card { background:white; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05); transition:all 0.3s; border-left:4px solid #ddd; }
        .user-card.status-active { border-left-color:#2ecc71; }
        .user-card.status-warning { border-left-color:#ffa502; }
        .user-card.status-emergency { border-left-color:#ff4757; animation:shake 0.4s infinite; }
        @keyframes shake { 0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);} }
        .user-header { display:flex; align-items:center; gap:10px; margin-bottom:15px; }
        .user-status-icon { font-size:24px; }
        .user-name { font-size:18px; font-weight:bold; }
        .user-room { color:#666; font-size:14px; }
        .user-activity { margin:15px 0; padding:12px; background:#f8f9fa; border-radius:8px; font-size:14px; }
        .user-activity .activity-type { font-weight:bold; margin-bottom:5px; }
        .user-activity .activity-detail { color:#666; }

        /* í™œë™ í”¼ë“œ */
        .activity-feed { background:white; border-radius:12px; padding:25px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-top:30px; }
        .activity-item { padding:15px; margin-bottom:10px; background:#f8f9fa; border-left:4px solid #ddd; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
        .activity-item.emergency { border-left-color:#ff4757; background:#fff5f5; }
        .activity-item.warning { border-left-color:#ffa502; background:#fffaf2; }
        .activity-time { font-size:12px; color:#999; }

        /* ëª¨ë‹¬ */
        .emergency-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; }
        .emergency-modal.show { display:flex; }
        .modal-content { background:white; padding:40px; border-radius:16px; max-width:450px; width:90%; text-align:center; animation:modalPop 0.3s; }
        @keyframes modalPop { 0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;} }
        .modal-icon { font-size:80px; margin-bottom:20px; }
        .modal-title { font-size:24px; font-weight:bold; margin-bottom:10px; color:#ff4757; }
        .modal-detail { color:#666; margin-bottom:30px; line-height:1.6; }
        .modal-actions { display:flex; gap:10px; }

        /* WebSocket ìƒíƒœ í‘œì‹œ */
        .ws-status { position:fixed; bottom:20px; right:20px; padding:10px 20px; background:white; border-radius:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); font-size:12px; display:flex; align-items:center; gap:8px; }
        .ws-indicator { width:8px; height:8px; border-radius:50%; background:#2ecc71; animation:blink 2s infinite; }
        @keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.3;} }
        .hidden { display:none; }
        .server-badge { background:#28a745; color:white; padding:5px 10px; border-radius:5px; font-size:12px; font-weight:bold; margin-left:10px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸµ í¥ë¶€ì ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ <span class="server-badge">ğŸŒ ë°°í¬ ì„œë²„</span></h1>
        <p>ì‹ ê³  / ì–´ë¥´ì‹  ìƒíƒœ í†µí•© ëª¨ë‹ˆí„°ë§</p>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="section">
        <div class="section-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</div>
        <input id="username" type="text" placeholder="ì•„ì´ë””" value="admin_ssafy">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="password123">
        <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
        <div id="login-error" class="response-box error"></div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="dashboard-screen" class="hidden">
        <div class="header">
            <h1>ğŸ¥ ê´€ë¦¬ì í˜ì´ì§€</h1>
            <div class="notification" onclick="clearBadge();">
                ğŸ””<span id="notification-badge" class="notification-badge" style="display:none;">0</span>
            </div>
        </div>

        <!-- ë“±ë¡ ë²„íŠ¼ -->
        <div class="section">
            <button class="btn btn-primary" onclick="openDeviceModal()" style="margin-right:10px;">ğŸ“± ê¸°ê¸° ë“±ë¡</button>
            <button class="btn btn-success" onclick="openUserModal()" style="margin-right:10px;">ğŸ‘´ ì–´ë¥´ì‹  ë“±ë¡</button>
            <button class="btn btn-primary" onclick="showVisualizationScreen()">ğŸµ ê³¡ ì‹œê°í™”</button>
        </div>

        <div class="dashboard">
            <div class="section-title">ğŸ“Š ì‹¤ì‹œê°„ ì‹ ê³  ë¦¬ìŠ¤íŠ¸</div>
            <div id="res-emg-list" class="response-box"></div>

            <div class="section-title">ğŸ§‘â€ğŸ¦³ ë‹´ë‹¹ ì–´ë¥´ì‹  í˜„í™©</div>
            <div id="users-grid" class="users-grid"></div>

            <div class="section-title">ğŸ“ í™œë™ í”¼ë“œ</div>
            <div class="activity-feed">
                <div id="activity-list"><div style="color:#999;text-align:center;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>

        <div class="ws-status"><div class="ws-indicator"></div>ì‹¤ì‹œê°„ ì—°ê²°ë¨</div>
    </div>

    <!-- ì‹ ê³  ëª¨ë‹¬ -->
    <div id="emergency-modal" class="emergency-modal">
        <div class="modal-content">
            <div class="modal-icon">ğŸš¨</div>
            <div class="modal-title">ê¸´ê¸‰ ì‹ ê³  ë°œìƒ!</div>
            <div id="modal-detail" class="modal-detail"></div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="acknowledgeReport()">ì²˜ë¦¬ í™•ì¸</button>
                <button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê¸°ê¸° ë“±ë¡ ëª¨ë‹¬ -->
    <div id="device-modal" class="emergency-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-icon">ğŸ“±</div>
            <div class="modal-title" style="color:#667eea;">ê¸°ê¸° ë“±ë¡</div>
            <div style="text-align:left; margin-top:20px;">
                <input id="device-serial" type="text" placeholder="ê¸°ê¸° ì¼ë ¨ë²ˆí˜¸ (í•„ìˆ˜)" style="margin-bottom:15px;">
                <input id="device-location" type="text" placeholder="ì„¤ì¹˜ ìœ„ì¹˜ (ì„ íƒ, ì˜ˆ: 101í˜¸)" style="margin-bottom:15px;">
                <div id="device-register-response" class="response-box"></div>
            </div>
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn btn-success" onclick="registerDevice()">ë“±ë¡</button>
                <button class="btn btn-primary" onclick="closeDeviceModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì–´ë¥´ì‹  ë“±ë¡ ëª¨ë‹¬ -->
    <div id="user-modal" class="emergency-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-icon">ğŸ‘´</div>
            <div class="modal-title" style="color:#2ecc71;">ì–´ë¥´ì‹  ë“±ë¡</div>
            <div style="text-align:left; margin-top:20px;">
                <input id="user-name" type="text" placeholder="ì´ë¦„ (í•„ìˆ˜)" style="margin-bottom:15px;">
                <input id="user-birthdate" type="date" placeholder="ìƒë…„ì›”ì¼ (ì„ íƒ)" style="margin-bottom:15px;">
                <select id="user-gender" style="margin-bottom:15px;">
                    <option value="">ì„±ë³„ ì„ íƒ (ì„ íƒ)</option>
                    <option value="MALE">ë‚¨ì„±</option>
                    <option value="FEMALE">ì—¬ì„±</option>
                </select>
                <input id="user-contact" type="text" placeholder="ë¹„ìƒ ì—°ë½ì²˜ (ì„ íƒ)" style="margin-bottom:15px;">
                <select id="user-device" style="margin-bottom:15px;">
                    <option value="">ì—°ê²°í•  ê¸°ê¸° ì„ íƒ (í•„ìˆ˜)</option>
                </select>
                <textarea id="user-medical-notes" placeholder="ì˜ë£Œ ë©”ëª¨ (ì„ íƒ, ì§€ë³‘, ë³µìš©ì•½ ë“±)"></textarea>
                <div id="user-register-response" class="response-box"></div>
            </div>
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn btn-success" onclick="registerUser()">ë“±ë¡</button>
                <button class="btn btn-primary" onclick="closeUserModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê³¡ ì‹œê°í™” í™”ë©´ -->
    <div id="visualization-screen" class="hidden">
        <div class="section">
            <button class="btn btn-primary" onclick="showDashboardScreen()" style="margin-bottom:20px;">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div class="section">
            <label for="song-select" style="font-weight:bold; margin-right:10px;">ê³¡ ì„ íƒ:</label>
            <select id="song-select" onchange="onSongChange()" style="width:400px;">
                <option value="">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
        </div>

        <div id="song-visualization-container"></div>
    </div>
</div>

<script>
    // ì˜¤ë””ì˜¤ ì•Œë¦¼
    const alertAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');

    // API ë² ì´ìŠ¤
    const API_BASE = 'https://heungbuja.site/api';  // â­ ë°°í¬ ì„œë²„
    let accessToken = null;
    let adminId = null;
    let stompClient = null;

    // ì‹ ê³  ì¹´ë“œ ë°ì´í„° ì €ì¥
    let emergencyList = [];

    // ë¡œê·¸ì¸
    async function login(){
        const user = document.getElementById('username').value;
        const pwd  = document.getElementById('password').value;
        try {
            const res = await fetch(`${API_BASE}/admins/login`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({username:user, password:pwd})
            });
            if(!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            const data = await res.json();
            accessToken = data.accessToken;
            adminId     = data.userId;

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');

            // ì´ˆê¸° ë¡œë“œ
            loadDashboardData();
            connectWebSocket();
        } catch(e) {
            const errEl = document.getElementById('login-error');
            errEl.style.display='block';
            errEl.textContent = e.message;
        }
    }

    // ë°ì´í„° ë¡œë“œ â€“ ë‹´ë‹¹ ì–´ë¥´ì‹  & ê¸°ì¡´ ì‹ ê³ 
    async function loadDashboardData(){
        try {
            // ì–´ë¥´ì‹  ëª©ë¡
            const resUsers = await fetch(`${API_BASE}/admins/users`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(resUsers.ok) {
                const users = await resUsers.json();
                renderUsers(users);
            }
            // ê¸°ì¡´ ì‹ ê³  ëª©ë¡
            const resEmg = await fetch(`${API_BASE}/emergency/admins/reports`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(resEmg.ok) {
                const list = await resEmg.json();
                emergencyList = list; // ì„œë²„ì—ì„œ ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë¨
                renderEmergencyCards(emergencyList);
                // PENDING + CONFIRMEDë§Œ ë°°ì§€ì— í‘œì‹œ
                const pendingCount = emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length;
                updateBadge(pendingCount);
            }
        } catch(e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ì–´ë¥´ì‹  ì¹´ë“œ ë Œë”ë§
    function renderUsers(users){
        const grid = document.getElementById('users-grid');
        grid.innerHTML = '';
        users.forEach(u => {
            let cls = 'status-active';
            let icon = 'ğŸŸ¢';
            if (u.healthStatus === 'EMERGENCY') { cls = 'status-emergency'; icon = 'ğŸš¨'; }
            else if (!u.isActive)         { cls = 'status-warning';  icon = 'ğŸŸ¡'; }

            // ìµœê·¼ í™œë™ ë Œë”ë§
            let activitiesHtml = '';
            if (u.recentActivities && u.recentActivities.length > 0) {
                activitiesHtml = '<div style="margin-top:12px; padding-top:12px; border-top:1px solid #eee;">' +
                    '<div style="font-size:12px; color:#999; margin-bottom:8px;">ìµœê·¼ í™œë™</div>';
                u.recentActivities.forEach(a => {
                    activitiesHtml += `<div style="font-size:13px; color:#666; margin-bottom:4px;">${a.icon} ${a.description} <span style="color:#999; font-size:11px;">(${a.timeAgo})</span></div>`;
                });
                activitiesHtml += '</div>';
            } else {
                activitiesHtml = '<div style="margin-top:12px; padding-top:12px; border-top:1px solid #eee; font-size:12px; color:#999;">ìµœê·¼ í™œë™ ì—†ìŒ</div>';
            }

            const div = document.createElement('div');
            div.className = `user-card ${cls}`;
            div.setAttribute('data-user-id', u.id);  // userId ì¶”ì ìš©
            div.innerHTML = `
            <div class="user-header"><span class="user-status-icon">${icon}</span>
                <div>
                  <div class="user-name">${u.name}</div>
                  <div class="user-room">${u.emergencyContact||''}</div>
                </div>
            </div>
            <div class="user-activity">
              <div class="activity-type">${u.healthStatus||'ì •ìƒ'} ìƒíƒœ</div>
              <div class="activity-detail">${u.medicalNotes||'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}</div>
            </div>
            ${activitiesHtml}
        `;
            grid.appendChild(div);
        });
    }

    // ì‹ ê³  ì¹´ë“œ ë Œë”ë§
    function renderEmergencyCards(list){
        const container = document.getElementById('res-emg-list');
        if (!Array.isArray(list) || list.length === 0) {
            container.className = 'response-box show success';
            container.innerHTML = '<p style="padding:10px;">ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        container.className = 'response-box show success';

        // ìƒíƒœ í•œê¸€ ë³€í™˜
        const statusText = {
            'PENDING': 'ëŒ€ê¸°ì¤‘',
            'CONFIRMED': 'í™•ì •ë¨',
            'RESOLVED': 'ì²˜ë¦¬ì™„ë£Œ',
            'FALSE_ALARM': 'ì˜¤íƒ'
        };

        container.innerHTML = `
      <div class="emergency-list">
        ${list.map(item => `
          <div class="emergency-card ${item.status.toLowerCase()}">
            <div class="card-header">
              <span class="report-id">#${item.reportId}</span>
              <span class="status">${statusText[item.status] || item.status}</span>
            </div>
            <div class="card-body">
              <p><strong>ì‹ ê³ ì:</strong> ${item.userName} (${item.userId})</p>
              <p><strong>ë°œí™” ë‚´ìš©:</strong> "${item.fullText || item.triggerWord}"</p>
              <p><strong>íŠ¸ë¦¬ê±° ë‹¨ì–´:</strong> ${item.triggerWord}</p>
              <p><strong>í™•ì¸ì—¬ë¶€:</strong>
                <span class="${item.isConfirmed?'ok':'no'}">
                  ${item.isConfirmed?'í™•ì¸ë¨':'ë¯¸í™•ì¸'}
                </span>
              </p>
              <p><strong>ë°œìƒì‹œê°„:</strong> ${new Date(item.reportedAt).toLocaleString('ko-KR')}</p>
              ${item.message?`<p><strong>ë©”ì‹œì§€:</strong> ${item.message}</p>`:''}
            </div>
            ${item.status==='PENDING' || item.status==='CONFIRMED'
            ? `<button class="resolve-btn" onclick="handleEmergencyResolve(${item.reportId})">âœ… ì²˜ë¦¬</button>`
            : `<div class="resolved-label">âœ” ì²˜ë¦¬ ì™„ë£Œ</div>`
        }
          </div>
        `).join('')}
      </div>
    `;
    }

    // ì‹ ê³  ì²˜ë¦¬ ë²„íŠ¼
    async function handleEmergencyResolve(id){
        if (!accessToken) { alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!'); return; }
        const notes = 'ê´€ë¦¬ì í™•ì¸ ì™„ë£Œ';
        try {
            const res = await fetch(`${API_BASE}/emergency/admins/reports/${id}?notes=${encodeURIComponent(notes)}`, {
                method:'PUT',
                headers:{Authorization:`Bearer ${accessToken}`}
            });
            if (res.ok) {
                alert(`#${id} ì‹ ê³ ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // ğŸ”¥ í•´ë‹¹ ì‹ ê³ ì˜ userId ì°¾ê¸°
                const report = emergencyList.find(item => item.reportId === id);
                if (report) {
                    // ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬
                    resetUserCardToNormal(report.userId);
                }

                // ìƒíƒœ ë³€ê²½ ë°˜ì˜
                emergencyList = emergencyList.map(item => item.reportId===id ? {...item, status:'RESOLVED'} : item);
                renderEmergencyCards(emergencyList);
                updateBadge(emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length);
            } else {
                const err = await res.json();
                alert('ì²˜ë¦¬ ì‹¤íŒ¨: '+(err.message||res.statusText));
            }
        } catch(e){
            alert('ì—ëŸ¬ ë°œìƒ: '+e.message);
        }
    }

    // WebSocket ì—°ê²°
    function connectWebSocket(){
        const socket = new SockJS(`${API_BASE}/ws`);
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
            console.log('ğŸ‘¤ í˜„ì¬ adminId:', adminId);
            const subscribePath = `/topic/admin/${adminId}/emergency`;
            console.log('ğŸ”” êµ¬ë… ê²½ë¡œ:', subscribePath);

            stompClient.subscribe(subscribePath, msg => {
                console.log('ğŸ“© WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ !', msg.body);
                const alertData = JSON.parse(msg.body);
                alertAudio.play();

                // Null-safe ì²˜ë¦¬
                const userName = alertData.userName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const triggerWord = alertData.triggerWord || 'ë¯¸ìƒ';
                const fullText = alertData.fullText || triggerWord;  // ì „ì²´ ë°œí™” í…ìŠ¤íŠ¸

                addActivity('emergency', userName, `ì‹ ê³ : "${fullText}"`);

                // ğŸ”¥ í•´ë‹¹ ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì¦‰ì‹œ ê¸´ê¸‰ ìƒíƒœë¡œ ë³€ê²½
                updateUserCardToEmergency(alertData.userId, userName);

                // ğŸ”¥ ë Œë”ë§ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜í•´ì„œ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                const emergencyItem = {
                    reportId: alertData.reportId,
                    userId: alertData.userId,
                    userName: userName,
                    triggerWord: triggerWord,
                    fullText: fullText,  // ì „ì²´ ë°œí™” í…ìŠ¤íŠ¸ ì¶”ê°€
                    reportedAt: alertData.reportedAt,
                    status: 'CONFIRMED',      // WebSocketìœ¼ë¡œ ì˜¨ ê±´ ì´ë¯¸ confirmëœ ìƒíƒœ
                    isConfirmed: true,
                    message: null
                };

                // ë¦¬ìŠ¤íŠ¸ ìµœìƒë‹¨ì— ì¶”ê°€
                emergencyList.unshift(emergencyItem);
                renderEmergencyCards(emergencyList);
                updateBadge(emergencyList.filter(i=>i.status==='PENDING' || i.status==='CONFIRMED').length);

                // ëª¨ë‹¬ íŒì—…
                document.getElementById('modal-detail').innerHTML =
                    `<b>${userName}</b> ì–´ë¥´ì‹ ì´ ê¸´ê¸‰ ì‹ ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
               ë°œí™” ë‚´ìš©: "<strong>${fullText}</strong>"<br>
               íŠ¸ë¦¬ê±° ë‹¨ì–´: "<strong>${triggerWord}</strong>"<br>
               ë°œìƒì‹œê°„: ${new Date(alertData.reportedAt).toLocaleString('ko-KR')}`;
                document.getElementById('emergency-modal').classList.add('show');
            });
            stompClient.subscribe(`/topic/admin/${adminId}/user-status`, msg => {
                const statusData = JSON.parse(msg.body);
                addActivity(statusData.status==='EMERGENCY'?'emergency':'warning',
                    statusData.userName, statusData.message);
                loadDashboardData(); // ì–´ë¥´ì‹  ì¹´ë“œ ìƒíƒœ ê°±ì‹ 
            });
        });
    }

    // ğŸ”¥ ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ê¸´ê¸‰ ìƒíƒœë¡œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    function updateUserCardToEmergency(userId, userName) {
        const card = document.querySelector(`.user-card[data-user-id="${userId}"]`);
        if (!card) {
            console.warn(`User card not found for userId: ${userId}`);
            return;
        }

        // ê¸°ì¡´ status í´ë˜ìŠ¤ ì œê±° í›„ emergency ì¶”ê°€
        card.classList.remove('status-active', 'status-warning');
        card.classList.add('status-emergency');

        // ì•„ì´ì½˜ ë³€ê²½
        const icon = card.querySelector('.user-status-icon');
        if (icon) icon.textContent = 'ğŸš¨';

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
        const activityType = card.querySelector('.activity-type');
        if (activityType) activityType.textContent = 'EMERGENCY ìƒíƒœ';

        console.log(`âœ… User card updated to EMERGENCY for userId: ${userId}, name: ${userName}`);
    }

    // ğŸ”¥ ì–´ë¥´ì‹  ì¹´ë“œë¥¼ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬
    function resetUserCardToNormal(userId) {
        const card = document.querySelector(`.user-card[data-user-id="${userId}"]`);
        if (!card) {
            console.warn(`User card not found for userId: ${userId}`);
            return;
        }

        // emergency í´ë˜ìŠ¤ ì œê±°, active ì¶”ê°€
        card.classList.remove('status-emergency', 'status-warning');
        card.classList.add('status-active');

        // ì•„ì´ì½˜ì„ ì •ìƒìœ¼ë¡œ ë³€ê²½
        const icon = card.querySelector('.user-status-icon');
        if (icon) icon.textContent = 'ğŸŸ¢';

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
        const activityType = card.querySelector('.activity-type');
        if (activityType) activityType.textContent = 'ì •ìƒ ìƒíƒœ';

        console.log(`âœ… User card reset to NORMAL for userId: ${userId}`);
    }

    // í™œë™ í”¼ë“œ
    function addActivity(type,userName,detail){
        const list = document.getElementById('activity-list');
        if(list.children.length===1 && list.children[0].textContent.includes('í™œë™ ë‚´ì—­')) {
            list.innerHTML='';
        }
        const item = document.createElement('div');
        item.className=`activity-item ${type}`;
        item.innerHTML=`<div>${type==='emergency'?'ğŸš¨':'âš ï¸'} <strong>${userName}</strong> - ${detail}</div>
                     <div class="activity-time">${new Date().toLocaleTimeString('ko-KR')}</div>`;
        list.prepend(item);
        while(list.children.length>10) list.removeChild(list.lastChild);
    }

    // ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateBadge(count){
        const badge = document.getElementById('notification-badge');
        if(count>0) {
            badge.style.display='flex';
            badge.textContent = count;
        } else {
            badge.style.display='none';
        }
    }
    function clearBadge(){
        updateBadge(0);
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal(){
        document.getElementById('emergency-modal').classList.remove('show');
    }
    function acknowledgeReport(){
        // ëª¨ë‹¬ì—ì„œ ì²˜ë¦¬ ë²„íŠ¼ ëˆ„ë¥´ë©´ ëª¨ë‹¬ë§Œ ë‹«ê³  ë¦¬ìŠ¤íŠ¸ëŠ” ì¹´ë“œ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬
        closeModal();
    }

    // ê¸°ê¸° ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    function openDeviceModal(){
        document.getElementById('device-modal').classList.add('show');
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('device-serial').value = '';
        document.getElementById('device-location').value = '';
        document.getElementById('device-register-response').className = 'response-box';
    }
    function closeDeviceModal(){
        document.getElementById('device-modal').classList.remove('show');
    }

    // ê¸°ê¸° ë“±ë¡
    async function registerDevice(){
        const serial = document.getElementById('device-serial').value.trim();
        const location = document.getElementById('device-location').value.trim();
        const responseBox = document.getElementById('device-register-response');

        if(!serial){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ê¸°ê¸° ì¼ë ¨ë²ˆí˜¸ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.';
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/admins/devices`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    serialNumber: serial,
                    location: location || null
                })
            });

            if(res.ok){
                const data = await res.json();
                responseBox.className = 'response-box show success';
                responseBox.textContent = `ê¸°ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${data.id})`;

                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeDeviceModal();
                }, 2000);
            } else {
                const error = await res.json();
                responseBox.className = 'response-box show error';
                responseBox.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${error.message || res.statusText}`;
            }
        } catch(e){
            responseBox.className = 'response-box show error';
            responseBox.textContent = `ì—ëŸ¬ ë°œìƒ: ${e.message}`;
        }
    }

    // ì–´ë¥´ì‹  ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    async function openUserModal(){
        document.getElementById('user-modal').classList.add('show');
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('user-name').value = '';
        document.getElementById('user-birthdate').value = '';
        document.getElementById('user-gender').value = '';
        document.getElementById('user-contact').value = '';
        document.getElementById('user-device').value = '';
        document.getElementById('user-medical-notes').value = '';
        document.getElementById('user-register-response').className = 'response-box';

        // ê¸°ê¸° ëª©ë¡ ë¡œë“œ
        await loadDevicesForSelect();
    }
    function closeUserModal(){
        document.getElementById('user-modal').classList.remove('show');
    }

    // ê¸°ê¸° ëª©ë¡ì„ ì…€ë ‰íŠ¸ë°•ìŠ¤ì— ë¡œë“œ (ì—°ê²° ê°€ëŠ¥í•œ ê¸°ê¸°ë§Œ)
    async function loadDevicesForSelect(){
        try {
            // availableOnly=true íŒŒë¼ë¯¸í„°ë¡œ ì—°ê²° ì•ˆëœ ê¸°ê¸°ë§Œ ìš”ì²­
            const res = await fetch(`${API_BASE}/admins/devices?availableOnly=true`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });
            if(res.ok){
                const devices = await res.json();

                const select = document.getElementById('user-device');
                select.innerHTML = '<option value="">ì—°ê²°í•  ê¸°ê¸° ì„ íƒ (í•„ìˆ˜)</option>';

                if(devices.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê¸°ê¸°ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.';
                    option.disabled = true;
                    select.appendChild(option);
                } else {
                    devices.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.id;
                        option.textContent = `${d.serialNumber} ${d.location ? '('+d.location+')' : ''}`;
                        select.appendChild(option);
                    });
                }
            }
        } catch(e){
            console.error('ê¸°ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ì–´ë¥´ì‹  ë“±ë¡
    async function registerUser(){
        const name = document.getElementById('user-name').value.trim();
        const birthDate = document.getElementById('user-birthdate').value;
        const gender = document.getElementById('user-gender').value;
        const contact = document.getElementById('user-contact').value.trim();
        const deviceId = document.getElementById('user-device').value;
        const medicalNotes = document.getElementById('user-medical-notes').value.trim();
        const responseBox = document.getElementById('user-register-response');

        if(!name){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.';
            return;
        }

        if(!deviceId){
            responseBox.className = 'response-box show error';
            responseBox.textContent = 'ì—°ê²°í•  ê¸°ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
            return;
        }

        try {
            const requestBody = {
                name: name,
                deviceId: parseInt(deviceId)
            };

            // ì„ íƒ í•„ë“œë“¤ ì¶”ê°€
            if(birthDate) requestBody.birthDate = birthDate;
            if(gender) requestBody.gender = gender;
            if(contact) requestBody.emergencyContact = contact;
            if(medicalNotes) requestBody.medicalNotes = medicalNotes;

            const res = await fetch(`${API_BASE}/admins/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(requestBody)
            });

            if(res.ok){
                const data = await res.json();
                responseBox.className = 'response-box show success';
                responseBox.textContent = `ì–´ë¥´ì‹ ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${data.id})`;

                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸° ë° ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    closeUserModal();
                    loadDashboardData();
                }, 2000);
            } else {
                const error = await res.json();
                responseBox.className = 'response-box show error';
                responseBox.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${error.message || res.statusText}`;
            }
        } catch(e){
            responseBox.className = 'response-box show error';
            responseBox.textContent = `ì—ëŸ¬ ë°œìƒ: ${e.message}`;
        }
    }

    // ===== ê³¡ ì‹œê°í™” ê´€ë ¨ í•¨ìˆ˜ =====

    async function showVisualizationScreen() {
        document.getElementById('dashboard-screen').classList.add('hidden');
        document.getElementById('visualization-screen').classList.remove('hidden');

        // ê³¡ ëª©ë¡ ë¡œë“œ
        await loadSongList();
    }

    async function loadSongList() {
        try {
            const res = await fetch(`${API_BASE}/admin/songs`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });

            if (!res.ok) throw new Error('ê³¡ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');

            const songs = await res.json();
            const select = document.getElementById('song-select');
            select.innerHTML = '<option value="">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”...</option>';

            songs.forEach(song => {
                const option = document.createElement('option');
                option.value = song.id;
                option.textContent = `${song.title} - ${song.artist}`;
                select.appendChild(option);
            });

            // ì²« ë²ˆì§¸ ê³¡ ìë™ ì„ íƒ (ìˆì„ ê²½ìš°)
            if (songs.length > 0) {
                select.value = songs[0].id;
                loadSongVisualization(songs[0].id);
            }
        } catch(e) {
            console.error('ê³¡ ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', e);
            alert('ê³¡ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }

    function onSongChange() {
        const select = document.getElementById('song-select');
        const songId = select.value;

        if (songId) {
            loadSongVisualization(parseInt(songId));
        } else {
            document.getElementById('song-visualization-container').innerHTML = '';
        }
    }

    function showDashboardScreen() {
        document.getElementById('visualization-screen').classList.add('hidden');
        document.getElementById('dashboard-screen').classList.remove('hidden');
    }

    async function loadSongVisualization(songId) {
        try {
            const res = await fetch(`${API_BASE}/admin/songs/${songId}/visualization`, {
                headers: {Authorization: `Bearer ${accessToken}`}
            });

            if (!res.ok) throw new Error('ì‹œê°í™” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

            const data = await res.json();
            console.log('ì‹œê°í™” ë°ì´í„°:', data);
            renderVisualization(data);
        } catch(e) {
            console.error('ì‹œê°í™” ë¡œë“œ ì—ëŸ¬:', e);
            alert('ê³¡ ì‹œê°í™” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }

    function renderVisualization(data) {
        const container = document.getElementById('song-visualization-container');

        // ë©”íŠ¸ë¡œë†ˆ ë¹„íŠ¸ ë°ì´í„° ì¤€ë¹„
        const beats = data.songBeat.beats || [];
        const sections = data.songBeat.sections || [];

        // HTML í…œí”Œë¦¿ (Toss ìŠ¤íƒ€ì¼ë¡œ ê¹”ë”í•˜ê²Œ)
        container.innerHTML = `
            <style>
                .viz-container { max-width: 1200px; margin: 0 auto; background: white; }
                .viz-header { background: white; padding: 40px 50px; border-bottom: 1px solid #e5e7eb; }
                .viz-header h1 { font-size: 28px; margin-bottom: 8px; color: #191f28; font-weight: 700; }
                .viz-song-info { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
                .viz-song-title { font-size: 22px; font-weight: 600; color: #4e5968; }
                .viz-song-meta { display: flex; gap: 20px; font-size: 15px; color: #8b95a1; }
                .viz-controls { padding: 24px 50px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px; }
                .viz-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 15px; cursor: pointer; transition: all 0.2s; font-weight: 600; }
                .viz-btn-primary { background: #3182f6; color: white; }
                .viz-btn-primary:hover { background: #1b64da; }
                .viz-btn-secondary { background: #f2f4f6; color: #4e5968; }
                .viz-btn-secondary:hover { background: #e5e8eb; }
                .viz-section { padding: 40px 50px; background: white; }
                .viz-current-section { text-align: center; margin-bottom: 32px; padding: 24px; background: #f9fafb; border-radius: 16px; border: 1px solid #e5e7eb; }
                .viz-section-name { font-size: 20px; font-weight: 700; color: #191f28; margin-bottom: 8px; }
                .viz-time-display { font-size: 32px; font-weight: 700; color: #3182f6; letter-spacing: 1px; }
                .viz-progress-container { margin: 32px 0; }
                .viz-progress-wrapper { position: relative; height: 60px; background: #f9fafb; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; }
                .viz-progress-bar { position: absolute; top: 0; left: 0; height: 100%; background: #3182f6; width: 0%; transition: width 0.3s; }
                .viz-section-markers { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; }
                .viz-section-marker { flex: 1; border-right: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: #8b95a1; padding: 8px; }

                /* ë©”íŠ¸ë¡œë†ˆ */
                .viz-beat-visualizer { margin: 32px 0; padding: 32px; background: #f9fafb; border-radius: 16px; border: 1px solid #e5e7eb; }
                .viz-beat-visualizer h3 { font-size: 16px; font-weight: 700; color: #191f28; margin-bottom: 24px; }
                .viz-metronome-display { display: flex; align-items: center; justify-content: space-between; gap: 32px; }
                .viz-bar-info, .viz-bpm-info { display: flex; flex-direction: column; align-items: center; gap: 8px; }
                .viz-bar-label, .viz-bpm-label { font-size: 12px; font-weight: 600; color: #8b95a1; text-transform: uppercase; }
                .viz-bar-number, .viz-bpm-value { font-size: 32px; font-weight: 700; color: #3182f6; }
                .viz-beat-indicators { flex: 1; display: flex; gap: 16px; justify-content: center; }
                .viz-beat-dot { width: 80px; height: 80px; border-radius: 50%; background: white; border: 3px solid #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: #8b95a1; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
                .viz-beat-dot[data-beat="1"] { border-color: #3182f6; }
                .viz-beat-dot.active { background: #3182f6; color: white; transform: scale(1.2); box-shadow: 0 0 0 8px rgba(49, 130, 246, 0.2); animation: vizBeatPing 0.3s ease-out; }
                .viz-beat-dot[data-beat="1"].active { background: #1b64da; transform: scale(1.3); box-shadow: 0 0 0 12px rgba(49, 130, 246, 0.3); }
                @keyframes vizBeatPing { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(49, 130, 246, 0.7); } 50% { transform: scale(1.25); } 100% { box-shadow: 0 0 0 12px rgba(49, 130, 246, 0); } }

                /* íƒ€ì„ë¼ì¸ */
                .viz-timeline { margin: 32px 0; }
                .viz-timeline h3 { font-size: 18px; font-weight: 700; color: #191f28; margin-bottom: 24px; }
                .viz-timeline-track { display: flex; flex-direction: column; gap: 16px; }
                .viz-timeline-item { display: flex; align-items: center; padding: 20px 24px; background: #f9fafb; border-radius: 16px; border: 2px solid #e5e7eb; transition: all 0.3s; }
                .viz-timeline-item.past { opacity: 0.5; }
                .viz-timeline-item.current { background: white; border-color: #3182f6; box-shadow: 0 4px 16px rgba(49, 130, 246, 0.15); }
                .viz-timeline-item.upcoming { opacity: 0.8; }
                .viz-timeline-indicator { width: 8px; height: 8px; border-radius: 50%; background: #e5e7eb; }
                .viz-timeline-item.past .viz-timeline-indicator { background: #10b981; }
                .viz-timeline-item.current .viz-timeline-indicator { background: #3182f6; animation: vizIndicatorPulse 1.5s ease-in-out infinite; }
                @keyframes vizIndicatorPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(49, 130, 246, 0.7); } 50% { transform: scale(1.3); box-shadow: 0 0 0 8px rgba(49, 130, 246, 0); } }
                .viz-timeline-time { min-width: 80px; font-size: 18px; font-weight: 700; color: #3182f6; }
                .viz-timeline-item.past .viz-timeline-time { color: #8b95a1; }
                .viz-timeline-item.upcoming .viz-timeline-time { color: #4e5968; }
                .viz-timeline-content { flex: 1; margin-left: 24px; }
                .viz-timeline-lyric { font-size: 20px; font-weight: 600; color: #191f28; margin-bottom: 8px; }
                .viz-timeline-actions { display: flex; gap: 12px; flex-wrap: wrap; }
                .viz-action-chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: white; border-radius: 20px; font-size: 14px; font-weight: 600; color: #4e5968; border: 1px solid #e5e7eb; }
                .viz-timeline-item.current .viz-action-chip { background: #eff6ff; border-color: #3182f6; color: #3182f6; }
            </style>

            <div class="viz-container">
                <!-- í—¤ë” -->
                <div class="viz-header">
                    <h1>ê³¡ ì‹œê°í™” ë„êµ¬</h1>
                    <div class="viz-song-info">
                        <div class="viz-song-title">í¥ë¶€ì ì²´ì¡°ì†¡ - ì•„ì´ìœ </div>
                        <div class="viz-song-meta">
                            <span>BPM: ${data.bpm.toFixed(2)}</span>
                            <span>ê¸¸ì´: ${Math.floor(data.duration/60)}:${Math.floor(data.duration%60).toString().padStart(2,'0')}</span>
                        </div>
                    </div>
                </div>

                <!-- ì¬ìƒ ì»¨íŠ¸ë¡¤ -->
                <div class="viz-controls">
                    <button class="viz-btn viz-btn-primary" onclick="playVisualization()">â–¶ ì¬ìƒ</button>
                    <button class="viz-btn viz-btn-secondary" onclick="pauseVisualization()">â¸ ì¼ì‹œì •ì§€</button>
                    <button class="viz-btn viz-btn-secondary" onclick="stopVisualization()">â¹ ì •ì§€</button>
                </div>

                <!-- íƒ€ì„ë¼ì¸ -->
                <div class="viz-section">
                    <!-- í˜„ì¬ êµ¬ê°„ -->
                    <div class="viz-current-section">
                        <div class="viz-section-name" id="viz-section-name">Intro</div>
                        <div class="viz-time-display">
                            <span id="viz-current-time">0:00</span> / <span id="viz-total-time">${Math.floor(data.duration/60)}:${Math.floor(data.duration%60).toString().padStart(2,'0')}</span>
                        </div>
                    </div>

                    <!-- ì§„í–‰ ë°” -->
                    <div class="viz-progress-container">
                        <div class="viz-progress-wrapper">
                            <div class="viz-progress-bar" id="viz-progress-bar"></div>
                            <div class="viz-section-markers">
                                ${sections.map(s => `<div class="viz-section-marker">${s.label}<br>${formatTime(beats.find(b => b.i === s.startBeat)?.t || 0)}</div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- ë©”íŠ¸ë¡œë†ˆ -->
                    <div class="viz-beat-visualizer">
                        <h3>ë¹„íŠ¸ ì‹œê°í™” (ë©”íŠ¸ë¡œë†ˆ)</h3>
                        <div class="viz-metronome-display">
                            <div class="viz-bar-info">
                                <span class="viz-bar-label">ë§ˆë””</span>
                                <span class="viz-bar-number" id="viz-bar-number">1</span>
                            </div>
                            <div class="viz-beat-indicators">
                                <div class="viz-beat-dot" data-beat="1">1</div>
                                <div class="viz-beat-dot" data-beat="2">2</div>
                                <div class="viz-beat-dot" data-beat="3">3</div>
                                <div class="viz-beat-dot" data-beat="4">4</div>
                            </div>
                            <div class="viz-bpm-info">
                                <span class="viz-bpm-label">BPM</span>
                                <span class="viz-bpm-value">${data.bpm.toFixed(1)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- ê°€ì‚¬ & ë™ì‘ íƒ€ì„ë¼ì¸ -->
                    <div class="viz-timeline">
                        <h3>ê°€ì‚¬ & ë™ì‘ íƒ€ì„ë¼ì¸ (Verse1)</h3>
                        <div class="viz-timeline-track" id="viz-timeline-track">
                            ${renderTimelineItems(data.verse1Timeline, data.lyricsInfo)}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // ì‹œê°í™” ì¬ìƒ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™”
        window.vizData = data;
        window.vizIsPlaying = false;
        window.vizCurrentTime = 0;
        window.vizLastBeatIndex = -1;
    }

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    function renderTimelineItems(timeline, lyricsInfo) {
        if (!timeline || timeline.length === 0) return '<p>íƒ€ì„ë¼ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        // ë™ì‘ ì´ëª¨ì§€ ë§¤í•‘ (ì˜ˆì‹œ)
        const actionIcons = {
            1: 'ğŸ™Œ', 2: 'ğŸ‘', 3: 'ğŸ¤¸â€â™€ï¸', 4: 'ğŸ™†â€â™€ï¸',
            5: 'ğŸ‘', 6: 'ğŸ¤¸', 7: 'ğŸ™‹', 8: 'ğŸ¤·'
        };

        return timeline.slice(0, 10).map((event, idx) => {
            const cls = idx === 0 ? 'past' : idx === 1 ? 'current' : 'upcoming';
            const icon = actionIcons[event.actionCode] || 'ğŸ’ƒ';

            return `
                <div class="viz-timeline-item ${cls}">
                    <div class="viz-timeline-indicator"></div>
                    <div class="viz-timeline-time">${event.time.toFixed(1)}s</div>
                    <div class="viz-timeline-content">
                        <div class="viz-timeline-lyric">í¥ê²¨ìš´ ë¦¬ë“¬ì— ë§ì¶°</div>
                        <div class="viz-timeline-actions">
                            <div class="viz-action-chip">
                                <span>${icon}</span>
                                <span>${event.actionName}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ì‹œê°í™” ì¬ìƒ ê´€ë ¨ í•¨ìˆ˜
    function playVisualization() {
        if (!window.vizData) return;
        if (window.vizIsPlaying) return;

        window.vizIsPlaying = true;
        window.vizAnimationInterval = setInterval(() => {
            window.vizCurrentTime += 0.1;
            updateVisualizationUI(window.vizCurrentTime);
            updateBeatVisualizer(window.vizCurrentTime);
        }, 100);
    }

    function pauseVisualization() {
        window.vizIsPlaying = false;
        clearInterval(window.vizAnimationInterval);
    }

    function stopVisualization() {
        window.vizIsPlaying = false;
        clearInterval(window.vizAnimationInterval);
        window.vizCurrentTime = 0;
        updateVisualizationUI(0);
        updateBeatVisualizer(0);
    }

    function updateVisualizationUI(time) {
        const data = window.vizData;
        if (!data) return;

        // ì§„í–‰ ë°”
        const progress = (time / data.duration) * 100;
        document.getElementById('viz-progress-bar').style.width = progress + '%';

        // ì‹œê°„ í‘œì‹œ
        const min = Math.floor(time / 60);
        const sec = Math.floor(time % 60);
        document.getElementById('viz-current-time').textContent = `${min}:${sec.toString().padStart(2, '0')}`;

        // êµ¬ê°„ í‘œì‹œ
        const sections = data.songBeat.sections || [];
        const beats = data.songBeat.beats || [];
        let currentSection = 'Intro';

        for (let section of sections) {
            const startBeat = beats.find(b => b.i === section.startBeat);
            const endBeat = beats.find(b => b.i === section.endBeat);
            if (startBeat && endBeat && time >= startBeat.t && time <= endBeat.t) {
                currentSection = section.label;
                break;
            }
        }

        const sectionNames = {
            'intro': 'Intro',
            'verse1': 'Verse1 (1ì ˆ ì•ˆë¬´)',
            'break': 'Break (íœ´ì‹)',
            'verse2': 'Verse2 (2ì ˆ ì•ˆë¬´)'
        };
        document.getElementById('viz-section-name').textContent = sectionNames[currentSection] || currentSection;
    }

    function updateBeatVisualizer(time) {
        const data = window.vizData;
        if (!data) return;

        const beats = data.songBeat.beats || [];

        // í˜„ì¬ ì‹œê°„ì— ê°€ì¥ ê°€ê¹Œìš´ ë¹„íŠ¸ ì°¾ê¸°
        let currentBeat = null;
        let minDiff = Infinity;

        for (let beat of beats) {
            const diff = Math.abs(beat.t - time);
            if (diff < minDiff && beat.t <= time + 0.05) {
                minDiff = diff;
                currentBeat = beat;
            }
        }

        if (!currentBeat || currentBeat.i === window.vizLastBeatIndex) {
            return;
        }

        window.vizLastBeatIndex = currentBeat.i;

        // ë§ˆë”” ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        document.getElementById('viz-bar-number').textContent = currentBeat.bar;

        // ë¹„íŠ¸ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
        const beatDots = document.querySelectorAll('.viz-beat-dot');
        beatDots.forEach(dot => dot.classList.remove('active'));

        const activeDot = document.querySelector(`.viz-beat-dot[data-beat="${currentBeat.beat}"]`);
        if (activeDot) {
            activeDot.classList.add('active');
        }
    }
</script>
</body>
</html>
