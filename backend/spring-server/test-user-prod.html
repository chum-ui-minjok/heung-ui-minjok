<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í¥ë¶€ì ì‚¬ìš©ì í˜ì´ì§€ (ë°°í¬ ì„œë²„)</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Malgun Gothic',sans-serif; background:#f5f6fa; padding:30px; }
        .container { max-width:800px; margin:0 auto; }
        h1 { text-align:center; margin-bottom:20px; color:#333; }
        .section { background:white; border-radius:12px; padding:20px; margin-bottom:25px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
        input, select, textarea { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
        textarea { resize: vertical; min-height:80px; }
        .btn { padding:10px 20px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.2s; margin-right:5px; margin-bottom:5px; }
        .btn-primary { background:#667eea; color:white; }
        .btn-primary:hover { background:#5568d3; }
        .btn-success { background:#2ecc71; color:white; }
        .btn-success:hover { background:#27ae60; }
        .btn-danger { background:#e74c3c; color:white; }
        .btn-danger:hover { background:#c0392b; }
        .btn-warning { background:#f39c12; color:white; }
        .btn-warning:hover { background:#e67e22; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }
        .recording { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { background:#e74c3c; }
            50% { background:#c0392b; }
        }
        .music-player { background:#f8f9fa; border-radius:8px; padding:15px; margin-top:15px; }
        .music-info { margin-bottom:10px; }
        .music-info div { margin-bottom:5px; }
        .control-buttons { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
        .audio-visualizer { height:50px; background:#ecf0f1; border-radius:6px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:#7f8c8d; }
        .response-box { margin-top:15px; padding:15px; border-radius:6px; display:none; font-family:'Courier New',monospace; font-size:13px; }
        .response-box.show { display:block; }
        .response-box.success { background:#d4edda; border-left:4px solid #28a745; }
        .response-box.error { background:#f8d7da; border-left:4px solid #dc3545; }
        .emergency-list { display:grid; grid-template-columns:1fr; gap:15px; margin-top:10px; }
        .emergency-card { background:#fff; border-radius:10px; padding:15px; box-shadow:0 3px 8px rgba(0,0,0,0.08); transition:transform 0.2s ease,box-shadow 0.2s ease; }
        .emergency-card.new { border-left:4px solid #f39c12; }
        .emergency-card.resolved { border-left:4px solid #2ecc71; }
        .emergency-card.rejected { border-left:4px solid #e74c3c; }
        .emergency-card:hover { transform:translateY(-3px); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
        .status { font-weight:bold; }
        .ok { color:#2ecc71; font-weight:bold; }
        .no { color:#e74c3c; font-weight:bold; }
        .server-badge { background:#28a745; color:white; padding:5px 10px; border-radius:5px; font-size:12px; font-weight:bold; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ‘´ í¥ë¶€ì ì‚¬ìš©ì í˜ì´ì§€ (v1.1 - JWT ì¸ì¦) <span class="server-badge">ğŸŒ ë°°í¬ ì„œë²„</span></h1>

    <!-- ë¡œê·¸ì¸ -->
    <div class="section" id="login-section">
        <div><strong>ğŸ” ê¸°ê¸° ë¡œê·¸ì¸ (JWT ì¸ì¦)</strong></div>
        <div style="background:#fff3cd; padding:10px; border-radius:6px; margin-bottom:10px; font-size:13px;">
            âš ï¸ <strong>ë³´ì•ˆ ê°•í™” (v1.1.0)</strong><br>
            - ëª¨ë“  ìŒì„± ëª…ë ¹ APIëŠ” JWT ì¸ì¦ í•„ìˆ˜<br>
            - userIdëŠ” JWT í† í°ì—ì„œ ìë™ ì¶”ì¶œ (íŒŒë¼ë¯¸í„° ì „ë‹¬ ë¶ˆí•„ìš”)<br>
            - í…ŒìŠ¤íŠ¸ìš©: userId=1 ê³ ì •
        </div>
        <input type="text" id="device-serial" placeholder="DEVICE001" value="DEVICE001"/>
        <button class="btn btn-primary" onclick="deviceLogin()">ë¡œê·¸ì¸</button>
        <div id="res-device-login" class="response-box"></div>
    </div>

    <!-- ìŒì„± ëª…ë ¹ -->
    <div class="section" id="voice-section" style="display:none;">
        <div><strong>ğŸ¤ ìŒì„± ëª…ë ¹</strong></div>

        <!-- ìŒì„± ë…¹ìŒ -->
        <div style="margin-bottom:20px;">
            <h4>ìŒì„± ë…¹ìŒ ë° ì „ì†¡</h4>
            <div style="margin-bottom:10px;">
                <button id="btn-record" class="btn btn-danger" onclick="startRecording()">ğŸ™ï¸ ë…¹ìŒ ì‹œì‘ (5ì´ˆ)</button>
                <button id="btn-stop" class="btn btn-warning" onclick="stopRecording()" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>
                <button id="btn-send" class="btn btn-success" onclick="sendVoiceCommand()" disabled>ğŸ“¤ ìŒì„± ì „ì†¡</button>
            </div>
            <div class="audio-visualizer" id="record-status">ë…¹ìŒ ëŒ€ê¸° ì¤‘...</div>
        </div>

        <!-- í…ìŠ¤íŠ¸ ëª…ë ¹ (í…ŒìŠ¤íŠ¸ìš©) -->
        <div style="margin-bottom:20px;">
            <h4>í…ìŠ¤íŠ¸ ëª…ë ¹ (ë””ë²„ê¹…ìš©)</h4>
            <input type="text" id="voice-text" placeholder="ì˜ˆ: íƒœì§„ì•„ ë…¸ë˜ í‹€ì–´ì¤˜" value="íƒœì§„ì•„ ë…¸ë˜ í‹€ì–´ì¤˜"/>
            <button class="btn btn-primary" onclick="sendTextCommand()">í…ìŠ¤íŠ¸ ì „ì†¡</button>
        </div>

        <!-- ì‘ë‹µ í‘œì‹œ -->
        <div id="res-voice-command" class="response-box"></div>

        <!-- ìŒì•… ì¬ìƒê¸° -->
        <div id="music-player" class="music-player" style="display:none;">
            <h4>ğŸµ í˜„ì¬ ì¬ìƒ ì¤‘</h4>
            <div class="music-info">
                <div><strong>ê³¡ëª…:</strong> <span id="song-title">-</span></div>
                <div><strong>ê°€ìˆ˜:</strong> <span id="song-artist">-</span></div>
                <div><strong>ëª¨ë“œ:</strong> <span id="song-mode">-</span></div>
            </div>
            <audio id="song-audio" controls style="width:100%; margin-bottom:10px;"></audio>
            <audio id="tts-audio" style="display:none;"></audio>
            <div class="control-buttons">
                <button class="btn btn-warning" onclick="sendControlCommand('ì ê¹')">â¸ï¸ ì¼ì‹œì •ì§€</button>
                <button class="btn btn-success" onclick="sendControlCommand('ë‹¤ì‹œ í‹€ì–´ì¤˜')">â–¶ï¸ ì¬ìƒ</button>
                <button class="btn btn-primary" onclick="sendControlCommand('ë‹¤ìŒ')">â­ï¸ ë‹¤ìŒê³¡</button>
                <button class="btn btn-danger" onclick="sendControlCommand('ê·¸ë§Œ')">â¹ï¸ ì •ì§€</button>
            </div>
        </div>
    </div>

    <!-- ì‹ ê³  -->
    <div class="section" id="emergency-section" style="display:none;">
        <div><strong>ğŸš¨ ê¸´ê¸‰ ì‹ ê³ </strong></div>
        <input type="text" id="emg-trigger" placeholder="íŠ¸ë¦¬ê±° ë‹¨ì–´ (ì˜ˆ: ë„ì™€ì¤˜, ì‚´ë ¤ì¤˜)" value="ë„ì™€ì¤˜"/>
        <input type="text" id="emg-fulltext" placeholder="ì „ì²´ ë°œí™” í…ìŠ¤íŠ¸ (ì˜ˆ: í¥ë¶€ì•¼ ë„ì™€ì¤˜)" value="í¥ë¶€ì•¼ ë„ì™€ì¤˜"/>
        <select id="emg-type">
            <option value="FALL">ë‚™ìƒ</option>
            <option value="MEDICAL">ì˜ë£Œ ì‘ê¸‰</option>
            <option value="FIRE">í™”ì¬</option>
            <option value="CRIME">ë²”ì£„</option>
            <option value="OTHER">ê¸°íƒ€</option>
        </select>
        <input type="text" id="emg-location" placeholder="ìœ„ì¹˜ ì…ë ¥"/>
        <textarea id="emg-details" placeholder="ìƒì„¸ ì„¤ëª…"></textarea>
        <button class="btn btn-primary" onclick="createEmergency()">ì‹ ê³ í•˜ê¸°</button>
        <div id="res-emg-create" class="response-box"></div>
        <div id="emg-alerts" class="emergency-list"></div>
    </div>
</div>

<script>
    const API_BASE = 'https://heungbuja.site/api';  // â­ ë°°í¬ ì„œë²„
    let userToken = null;
    let userId = null;

    function showResponse(id,data,isError=false){
        const el = document.getElementById(id);
        el.className = `response-box show ${isError?'error':'success'}`;
        el.innerHTML = `<pre>${JSON.stringify(data,null,2)}</pre>`;
    }

    async function deviceLogin(){
        const deviceNumber = document.getElementById('device-serial').value;
        // âš ï¸ ì‹¤ì œë¡œëŠ” ì‚¬ìš©ì ì„ íƒ UIë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ì§€ë§Œ, í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ userId=1 ê³ ì •
        const testUserId = 1;

        try{
            const res = await fetch(`${API_BASE}/auth/device`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    serialNumber: deviceNumber,  // â† APIëŠ” serialNumberë¥¼ ë°›ìŒ
                    userId: testUserId
                })
            });
            const data = await res.json();
            showResponse('res-device-login', data, !res.ok);
            if(res.ok){
                userToken = data.accessToken;
                userId = testUserId; // JWTì—ì„œ ì¶”ì¶œë  userId
                document.getElementById('login-section').style.display='none';
                document.getElementById('voice-section').style.display='block';
                document.getElementById('emergency-section').style.display='block';
                alert(`âœ… ë¡œê·¸ì¸ ì„±ê³µ! (userId: ${userId})`);
            }
        }catch(e){showResponse('res-device-login',{error:e.message},true);}
    }

    async function createEmergency(){
        if(!userToken) return alert('ë¡œê·¸ì¸ í•„ìš”!');
        const body = {
            userId: userId,
            triggerWord: document.getElementById('emg-trigger').value || 'ë„ì™€ì¤˜',
            fullText: document.getElementById('emg-fulltext').value || null,
            emergencyType: document.getElementById('emg-type').value,
            location: document.getElementById('emg-location').value,
            details: document.getElementById('emg-details').value
        };
        try{
            const res = await fetch(`${API_BASE}/emergency`,{
                method:'POST',
                headers:{'Content-Type':'application/json','Authorization':`Bearer ${userToken}`},
                body: JSON.stringify(body)
            });
            const data = await res.json();
            showResponse('res-emg-create', data, !res.ok);
            if(res.ok) renderEmergencyAlert(data);
        }catch(e){showResponse('res-emg-create',{error:e.message},true);}
    }

    function renderEmergencyAlert(item){
        const container = document.getElementById('emg-alerts');
        const card = document.createElement('div');
        card.className='emergency-card new';
        card.innerHTML=`
    <div><strong>ì‹ ê³  #${item.reportId}</strong> - <span class="status">${item.status || 'NEW'}</span></div>
    <div><strong>ìœ ì € ID:</strong> ${item.userId}</div>
    <div><strong>ìœ ì € ì´ë¦„:</strong> ${item.userName}</div>
    <div><strong>ë°œí™” ë‚´ìš©:</strong> ${item.fullText || item.triggerWord}</div>
    <div><strong>íŠ¸ë¦¬ê±° ë‹¨ì–´:</strong> ${item.triggerWord}</div>
    <div><strong>í™•ì¸ ì—¬ë¶€:</strong> ${item.isConfirmed ? 'âœ”' : 'âŒ'}</div>
    <div><strong>ì‹ ê³  ì‹œê°„:</strong> ${new Date(item.reportedAt).toLocaleString()}</div>
    <div><strong>ë©”ì‹œì§€:</strong> ${item.message}</div>
    `;
        container.prepend(card);

        // ğŸ”Š ì•Œë¦¼ ì†Œë¦¬
        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        audio.play();
    }

    // ===== ìŒì„± ì¸í„°í˜ì´ìŠ¤ ê¸°ëŠ¥ =====
    let mediaRecorder = null;
    let audioChunks = [];
    let recordedBlob = null;

    // ìŒì„± ë…¹ìŒ ì‹œì‘
    async function startRecording(){
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                document.getElementById('btn-send').disabled = false;
                document.getElementById('record-status').textContent = 'ë…¹ìŒ ì™„ë£Œ! ì „ì†¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                document.getElementById('btn-record').disabled = false;
                document.getElementById('btn-stop').disabled = true;
                document.getElementById('btn-record').classList.remove('recording');
            };

            mediaRecorder.start();
            document.getElementById('btn-record').disabled = true;
            document.getElementById('btn-stop').disabled = false;
            document.getElementById('btn-record').classList.add('recording');
            document.getElementById('record-status').textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘... (5ì´ˆ í›„ ìë™ ì¤‘ì§€)';

            // 5ì´ˆ í›„ ìë™ ì¤‘ì§€
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                }
            }, 5000);

        } catch(e) {
            alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤: ' + e.message);
        }
    }

    // ìŒì„± ë…¹ìŒ ì¤‘ì§€
    function stopRecording(){
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
    }

    // ìŒì„± íŒŒì¼ ì „ì†¡ (ìŒì„± ì§ì ‘ ì‘ë‹µ)
    async function sendVoiceCommand(){
        if(!userToken) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
        if(!recordedBlob) return alert('ë…¹ìŒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!');

        const formData = new FormData();
        // âš ï¸ userIdëŠ” ì œê±°! JWT í† í°ì—ì„œ ìë™ ì¶”ì¶œë¨
        formData.append('audioFile', recordedBlob, 'voice.webm');

        try{
            document.getElementById('record-status').textContent = 'â³ ìŒì„± ì¸ì‹ ì¤‘...';
            const res = await fetch(`${API_BASE}/commands/process-audio`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${userToken}`
                    // âš ï¸ Content-Typeì€ ì„¤ì •í•˜ì§€ ë§ˆì„¸ìš”! (ìë™ ì„¤ì •ë¨)
                },
                body: formData
            });

            // í—¤ë”ì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (URL ë””ì½”ë”©)
            const success = res.headers.get('X-Success') === 'true';
            const intent = res.headers.get('X-Intent');
            const responseText = decodeURIComponent(res.headers.get('X-Response-Text') || '');
            const errorCode = res.headers.get('X-Error-Code');
            const songTitle = res.headers.get('X-Song-Title') ? decodeURIComponent(res.headers.get('X-Song-Title')) : null;
            const songArtist = res.headers.get('X-Song-Artist') ? decodeURIComponent(res.headers.get('X-Song-Artist')) : null;

            console.log('ğŸ“¥ ì‘ë‹µ í—¤ë”:');
            console.log('  HTTP Status:', res.status, res.statusText);
            console.log('  X-Success:', success);
            console.log('  X-Intent:', intent);
            console.log('  X-Error-Code:', errorCode);
            console.log('  X-Response-Text (ë””ì½”ë”© í›„):', responseText);
            console.log('  Content-Type:', res.headers.get('Content-Type'));

            // ì‘ë‹µ ë°”ë””ëŠ” MP3 ë°”ì´ë„ˆë¦¬ (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ìŒì„± ìˆìŒ)
            const audioBlob = await res.blob();
            console.log('ğŸ“¦ ì‘ë‹µ ë°”ë”” (Blob):', audioBlob);

            // ì‘ë‹µ ì •ë³´ í‘œì‹œ
            const responseData = {
                httpStatus: res.status,
                success: success,
                intent: intent,
                errorCode: errorCode,
                responseText: responseText,
                audioSize: audioBlob.size + ' bytes',
                songInfo: songTitle ? {title: songTitle, artist: songArtist} : null
            };
            showResponse('res-voice-command', responseData, !success);

            // ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ìŒì„± ì¬ìƒ
            const voiceData = {
                success: success,
                intent: intent,
                responseText: responseText,
                audioBlob: audioBlob,
                songInfo: songTitle ? {title: songTitle, artist: songArtist} : null
            };
            handleVoiceResponse(voiceData);

            document.getElementById('btn-send').disabled = true;
            document.getElementById('record-status').textContent = 'ë…¹ìŒ ëŒ€ê¸° ì¤‘...';
            recordedBlob = null;

        }catch(e){
            console.error('âŒ ì˜ˆì™¸ ë°œìƒ:', e);
            showResponse('res-voice-command',{error:e.message},true);
            document.getElementById('record-status').textContent = 'ì˜¤ë¥˜ ë°œìƒ!';
        }
    }

    // í…ìŠ¤íŠ¸ ëª…ë ¹ ì „ì†¡
    async function sendTextCommand(){
        if(!userToken) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');

        const text = document.getElementById('voice-text').value;
        try{
            const res = await fetch(`${API_BASE}/commands/text`,{
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'Authorization': `Bearer ${userToken}` // â­ JWT í† í° ì¶”ê°€
                },
                body:JSON.stringify({userId: userId, text: text})
            });
            const data = await res.json();
            showResponse('res-voice-command', data, !res.ok);

            if(res.ok && data.success){
                handleVoiceResponse(data);
            }
        }catch(e){showResponse('res-voice-command',{error:e.message},true);}
    }

    // ì¬ìƒ ì œì–´ ëª…ë ¹
    async function sendControlCommand(command){
        document.getElementById('voice-text').value = command;
        await sendTextCommand();
    }

    // ìŒì„± ì‘ë‹µ ì²˜ë¦¬
    async function handleVoiceResponse(data){
        console.log('ì‘ë‹µ ì²˜ë¦¬:', data);

        // 1. TTS ìŒì„± ì¬ìƒ (audioBlob ë˜ëŠ” ttsAudioUrl)
        const ttsAudio = document.getElementById('tts-audio');
        if(data.audioBlob){
            // ìƒˆ ë°©ì‹: Blob ë°ì´í„°ë¥¼ ì§ì ‘ ì¬ìƒ
            console.log('ğŸ”Š audioBlob ê°ì§€:', data.audioBlob);
            console.log('Blob í¬ê¸°:', data.audioBlob.size, 'bytes');
            console.log('Blob íƒ€ì…:', data.audioBlob.type);

            const audioUrl = URL.createObjectURL(data.audioBlob);
            console.log('ìƒì„±ëœ Blob URL:', audioUrl);

            ttsAudio.src = audioUrl;
            ttsAudio.play()
                .then(() => console.log('âœ… ìŒì„± ì¬ìƒ ì‹œì‘'))
                .catch(err => console.error('âŒ ìŒì„± ì¬ìƒ ì‹¤íŒ¨:', err));
        } else if(data.ttsAudioUrl){
            // ê¸°ì¡´ ë°©ì‹: URLë¡œ ì¬ìƒ
            console.log('ğŸ”Š ttsAudioUrl ì‚¬ìš©:', data.ttsAudioUrl);
            ttsAudio.src = API_BASE + data.ttsAudioUrl;
            ttsAudio.play()
                .then(() => console.log('âœ… ìŒì„± ì¬ìƒ ì‹œì‘'))
                .catch(err => console.error('âŒ ìŒì„± ì¬ìƒ ì‹¤íŒ¨:', err));
        } else {
            console.warn('âš ï¸ audioBlobë„ ttsAudioUrlë„ ì—†ìŒ');
        }

        // 2. ë…¸ë˜ ì¬ìƒ (songInfoê°€ ìˆëŠ” ê²½ìš°ë§Œ)
        if(data.songInfo){
            const player = document.getElementById('music-player');
            player.style.display = 'block';

            document.getElementById('song-title').textContent = data.songInfo.title || '-';
            document.getElementById('song-artist').textContent = data.songInfo.artist || '-';
            document.getElementById('song-mode').textContent = data.songInfo.mode || 'LISTENING';

            // audioUrlì´ ìˆì„ ë•Œë§Œ ë…¸ë˜ ì¬ìƒ
            if(data.songInfo.audioUrl){
                const songAudio = document.getElementById('song-audio');
                songAudio.src = data.songInfo.audioUrl;

                // TTS ì¬ìƒ í›„ ë…¸ë˜ ì¬ìƒ
                ttsAudio.onended = () => {
                    songAudio.play();
                };
            }
        }

        // 3. ì¬ìƒ ì œì–´ ì²˜ë¦¬
        const songAudio = document.getElementById('song-audio');
        switch(data.intent){
            case 'MUSIC_PAUSE':
                songAudio.pause();
                break;
            case 'MUSIC_RESUME':
                songAudio.play();
                break;
            case 'MUSIC_NEXT':
                // ë‹¤ìŒ ê³¡ ë¡œì§ (ì—¬ê¸°ì„œëŠ” í˜„ì¬ ê³¡ ì²˜ìŒìœ¼ë¡œ)
                songAudio.currentTime = 0;
                songAudio.play();
                break;
            case 'MUSIC_STOP':
                songAudio.pause();
                songAudio.currentTime = 0;
                document.getElementById('music-player').style.display = 'none';
                break;
        }

        // 4. ì‘ê¸‰ ìƒí™© ì²˜ë¦¬
        if(data.intent === 'EMERGENCY'){
            alert('ğŸš¨ ì‘ê¸‰ ìƒí™©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            songAudio.pause();
        }
    }

</script>
</body>
</html>
