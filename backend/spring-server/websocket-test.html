<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Advanced STOMP WebSocket Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>

<body>
<div class="container mt-4">
    <div class="row">
        <!-- 왼쪽 컬럼: 연결, 구독, 수동 전송 -->
        <div class="col-md-6">
            <h3>1. WebSocket 연결</h3>
            <div class="input-group mb-3">
                <input type="text" id="websocketUrl" class="form-control" value="ws://localhost:8080/ws">
                <button id="connectBtn" class="btn btn-primary">연결</button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>연결 끊기</button>
            </div>

            <h3 class="mt-4">2. 메시지 구독 (Subscribe)</h3>
            <div id="subscriptionList">
                <!-- 구독 폼이 여기에 동적으로 추가됩니다 -->
            </div>
            <button id="addSubscriptionBtn" class="btn btn-secondary mt-2">구독 추가</button>

            <hr class="my-4">

            <h3>3. 메시지 수동 전송 (Manual Send)</h3>
            <div class="mb-3">
                <label for="destinationPath" class="form-label">Destination (e.g., /app/game/ping)</label>
                <input type="text" id="destinationPath" class="form-control" value="/app/game/ping">
            </div>
            <div class="mb-3">
                <label for="manualMessage" class="form-label">Message (JSON)</label>
                <textarea id="manualMessage" class="form-control" rows="3" placeholder='{"key": "value"}'></textarea>
            </div>
            <button id="sendBtn" class="btn btn-success" disabled>수동 전송</button>
        </div>

        <!-- 오른쪽 컬럼: 자동 프레임 전송 및 로그 -->
        <div class="col-md-6">
            <h3>4. 자동 프레임 전송 (For Game Test)</h3>
            <div class="p-3 border rounded bg-light">
                <div class="mb-3">
                    <label for="sessionId" class="form-label">Session ID</label>
                    <input type="text" id="sessionId" class="form-control" value="a1b2c3d4-e5f6-7890-g1h2-i3j4k5l6m7n8">
                </div>
                <p><strong>Destination:</strong> <code>/app/game/frame</code> (고정)</p>

                <!-- ================== ▼ 수정된 부분 ▼ ================== -->
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <label for="startTime" class="form-label">시작 시간 (초)</label>
                            <input type="number" id="startTime" class="form-control" value="0">
                        </div>
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label for="intervalTime" class="form-label">전송 간격 (ms)</label>
                            <input type="number" id="intervalTime" class="form-control" value="100">
                        </div>
                    </div>
                </div>
                <!-- ================== ▲ 수정된 부분 ▲ ================== -->

                <button id="startSendingBtn" class="btn btn-info" disabled>자동 전송 시작</button>
                <button id="stopSendingBtn" class="btn btn-warning" disabled>자동 전송 중지</button>
                <p class="mt-2 mb-0"><strong>Current Play Time:</strong> <span id="playTimeDisplay">0.00</span></p>
            </div>

            <h3 class="mt-4">로그</h3>
            <div id="logBox" class="border p-3" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; background-color: #f8f9fa;"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const websocketUrlInput = document.getElementById('websocketUrl');
    const sendBtn = document.getElementById('sendBtn');
    const startSendingBtn = document.getElementById('startSendingBtn');
    const stopSendingBtn = document.getElementById('stopSendingBtn');
    const addSubscriptionBtn = document.getElementById('addSubscriptionBtn');
    const subscriptionList = document.getElementById('subscriptionList');
    const logBox = document.getElementById('logBox');

    let stompClient = null;
    let subscriptions = {}; // path: subscription
    let frameInterval = null;
    let currentPlayTime = 0.0;
    let subCounter = 0;

    function log(type, message, color) {
        const p = document.createElement('p');
        const timestamp = new Date().toLocaleTimeString();
        p.innerHTML = `<span style="color: ${color}; font-weight: bold;">[${type}]</span> [${timestamp}] ${message}`;
        p.className = 'mb-1';
        logBox.appendChild(p);
        logBox.scrollTop = logBox.scrollHeight;
    }

    const client = new StompJs.Client({
        reconnectDelay: 5000,
        heartbeatIncoming: 4000,
        heartbeatOutgoing: 4000,
    });

    client.onConnect = function (frame) {
        log('SYSTEM', 'STOMP 서버에 연결되었습니다.', 'green');
        setConnected(true);
    };

    client.onStompError = function (frame) {
        log('ERROR', `Broker reported error: ${frame.headers['message']}`, 'red');
        log('ERROR', `Additional details: ${frame.body}`, 'red');
    };

    client.onWebSocketError = function(event) {
        log('ERROR', 'WebSocket 연결에 실패했습니다. 서버가 실행 중인지, URL이 올바른지 확인하세요.', 'red');
        setConnected(false);
    };


    function setConnected(connected) {
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
        websocketUrlInput.disabled = connected;
        sendBtn.disabled = !connected;
        startSendingBtn.disabled = !connected;

        document.querySelectorAll('.subscribeBtn, .unsubscribeBtn, .sub-path-input').forEach(el => {
            el.disabled = !connected;
        });
        if (!connected) {
            stopAutoSend();
            startSendingBtn.disabled = true;
            stopSendingBtn.disabled = true;
        }
    }

    connectBtn.addEventListener('click', () => {
        const url = websocketUrlInput.value.trim();
        if (!url) {
            alert('WebSocket URL을 입력하세요.');
            return;
        }
        client.brokerURL = url;
        client.activate();
        log('SYSTEM', `${url}에 연결을 시도합니다...`, 'blue');
    });

    disconnectBtn.addEventListener('click', () => {
        client.deactivate();
        log('SYSTEM', '연결을 종료했습니다.', 'orange');
        setConnected(false);
        for (const path in subscriptions) {
            const subId = subscriptions[path].subId;
            const subInput = document.getElementById(`path-${subId}`);
            const subBtn = document.querySelector(`#subscription-${subId} .subscribeBtn`);
            const unsubBtn = document.querySelector(`#subscription-${subId} .unsubscribeBtn`);

            if(subInput) subInput.disabled = false;
            if(subBtn) {
                subBtn.disabled = false;
                subBtn.style.display = 'inline-block';
            }
            if(unsubBtn) unsubBtn.style.display = 'none';
        }
        subscriptions = {};
    });

    addSubscriptionBtn.addEventListener('click', () => {
        const subId = subCounter++;
        const subForm = document.createElement('div');
        subForm.className = 'input-group mb-2 subscription-form';
        subForm.id = `subscription-${subId}`;
        subForm.innerHTML = `
            <input type="text" class="form-control sub-path-input" placeholder="/topic/game/세션ID" id="path-${subId}" ${stompClient && stompClient.connected ? '' : 'disabled'}>
            <button class="btn btn-outline-primary subscribeBtn" data-sub-id="${subId}">구독</button>
            <button class="btn btn-outline-danger unsubscribeBtn" data-sub-id="${subId}" style="display: none;">해지</button>
        `;
        subscriptionList.appendChild(subForm);
    });

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('subscribeBtn')) {
            const subId = e.target.dataset.subId;
            const pathInput = document.getElementById(`path-${subId}`);
            const path = pathInput.value.trim();
            if (path && !subscriptions[path]) {
                const subscription = client.subscribe(path, (message) => {
                    log('RECV', `<strong>${path}</strong>: ${message.body}`, 'purple');
                });
                subscriptions[path] = { sub: subscription, subId: subId };
                log('SUB', `${path}를 구독했습니다.`, 'blue');

                pathInput.disabled = true;
                e.target.style.display = 'none';
                e.target.nextElementSibling.style.display = 'inline-block';
            }
        }
        if (e.target.classList.contains('unsubscribeBtn')) {
            const subId = e.target.dataset.subId;
            const pathInput = document.getElementById(`path-${subId}`);
            const path = pathInput.value.trim();
            if (path && subscriptions[path]) {
                subscriptions[path].sub.unsubscribe();
                delete subscriptions[path];
                log('UNSUB', `${path} 구독을 해지했습니다.`, 'orange');

                pathInput.disabled = false;
                e.target.style.display = 'none';
                e.target.previousElementSibling.style.display = 'inline-block';
            }
        }
    });

    sendBtn.addEventListener('click', () => {
        const destination = document.getElementById('destinationPath').value.trim();
        const messageBody = document.getElementById('manualMessage').value;
        if (!destination) {
            alert('Destination 경로를 입력하세요.');
            return;
        }
        try {
            JSON.parse(messageBody);
            client.publish({
                destination: destination,
                body: messageBody
            });
            log('SEND', `<strong>${destination}</strong>: ${messageBody}`, 'gray');
        } catch (error) {
            alert('메시지 형식이 유효한 JSON이 아닙니다.');
        }
    });

    // --- 자동 프레임 전송 로직 ---
    function stopAutoSend() {
        if (frameInterval) {
            clearInterval(frameInterval);
            frameInterval = null;
            startSendingBtn.disabled = false;
            stopSendingBtn.disabled = true;
            document.getElementById('sessionId').disabled = false;
            // <-- (수정) 시작 시간 입력란도 다시 활성화합니다.
            document.getElementById('startTime').disabled = false;
            log('SYSTEM', '자동 프레임 전송을 중지했습니다.', 'orange');
        }
    }

    startSendingBtn.addEventListener('click', () => {
        const sessionId = document.getElementById('sessionId').value.trim();
        // <-- (수정) 시작 시간과 간격 값을 읽어옵니다.
        const startTime = parseFloat(document.getElementById('startTime').value);
        const intervalTime = parseInt(document.getElementById('intervalTime').value, 10);

        if (!sessionId) {
            alert('Session ID를 입력하세요.');
            return;
        }
        // <-- (수정) 시작 시간 값의 유효성을 검사합니다.
        if (isNaN(startTime) || startTime < 0) {
            alert('올바른 시작 시간을 입력하세요 (0 이상의 숫자).');
            return;
        }
        if (isNaN(intervalTime) || intervalTime <= 0) {
            alert('올바른 전송 간격을 입력하세요.');
            return;
        }

        startSendingBtn.disabled = true;
        stopSendingBtn.disabled = false;
        document.getElementById('sessionId').disabled = true;
        // <-- (수정) 시작 시간 입력란도 비활성화합니다.
        document.getElementById('startTime').disabled = true;

        // <-- (수정) currentPlayTime을 입력받은 시작 시간으로 초기화합니다.
        currentPlayTime = startTime;
        document.getElementById('playTimeDisplay').textContent = currentPlayTime.toFixed(2);

        log('SYSTEM', `자동 프레임 전송을 시작합니다. (시작 시간: ${startTime}초, 간격: ${intervalTime}ms)`, 'green');

        frameInterval = setInterval(() => {
            const destination = '/app/game/frame';
            const message = {
                sessionId: sessionId,
                frameData: "Base64-encoded-image-string-example",
                currentPlayTime: parseFloat(currentPlayTime.toFixed(3))
            };
            const messageBody = JSON.stringify(message);

            client.publish({ destination, body: messageBody });
            log('AUTO-SEND', `playTime=${message.currentPlayTime}`, '#007bff');

            currentPlayTime += (intervalTime / 1000);
            document.getElementById('playTimeDisplay').textContent = currentPlayTime.toFixed(2);
        }, intervalTime);
    });

    stopSendingBtn.addEventListener('click', stopAutoSend);

</script>
</body>
</html>